<body>
    <!-- Весь ваш основной контент -->
    
    <script>
        // Добавьте сюда исправленный скрипт, который я предоставил
        const apiUrl = "https://v6.exchangerate-api.com/v6/020c6e77213ba847f6eaaf32/latest/USD";

        async function fetchRatesOncePerDay() {
            const storedData = localStorage.getItem("exchangeRates");
            const currentDate = new Date().toISOString().split("T")[0]; // Текущая дата

            if (storedData) {
                const parsedData = JSON.parse(storedData);
                if (parsedData.date === currentDate) {
                    console.log("Используются сохраненные курсы валют.");
                    return parsedData.rates;
                }
            }

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                const rates = data.conversion_rates;

                // Сохраняем курсы валют и дату в localStorage
                localStorage.setItem(
                    "exchangeRates",
                    JSON.stringify({ date: currentDate, rates: rates })
                );

                console.log("Курсы валют обновлены.");
                return rates;
            } catch (error) {
                console.error("Ошибка при получении данных о курсах валют:", error);
                throw new Error("Не удалось загрузить курсы валют.");
            }
        }

        async function convertCurrency() {
            const amount = parseFloat(document.getElementById("amount").value);
            const fromCurrency = document.getElementById("fromCurrency").value;
            const toCurrency = document.getElementById("toCurrency").value;
            const commissionRate = parseFloat(document.getElementById("commission").value) || 0;

            if (isNaN(amount) || amount <= 0) {
                document.getElementById("result").textContent = "Введите корректную сумму.";
                return;
            }

            try {
                const rates = await fetchRatesOncePerDay();

                if (rates[fromCurrency] && rates[toCurrency]) {
                    const baseAmount = amount / rates[fromCurrency];
                    const convertedAmount = baseAmount * rates[toCurrency];
                    const commission = (commissionRate / 100) * convertedAmount;
                    const totalAmount = convertedAmount - commission;

                    const selectedLanguage = document.getElementById("language").value;
                    const resultTranslations = {
                        ru: "Изначальная сумма",
                        en: "Initial Amount",
                        uk: "Початкова сума",
                        ar: "المبلغ الأولي"
                    };

                    const resultText = resultTranslations[selectedLanguage] || "Изначальная сумма";

                    document.getElementById("result").innerHTML = `
                        ${resultText}: ${amount.toFixed(2)} ${fromCurrency}<br>
                        Конвертированная сумма: ${convertedAmount.toFixed(2)} ${toCurrency}<br>
                        Итоговая сумма: ${totalAmount.toFixed(2)} ${toCurrency}
                    `;
                } else {
                    document.getElementById("result").textContent = "Ошибка конвертации валют.";
                }
            } catch (error) {
                document.getElementById("result").textContent = "Ошибка загрузки курсов валют.";
            }
        }

        document.getElementById("language").addEventListener("change", function () {
            const selectedLanguage = document.getElementById("language").value;

            const translations = {
                ru: {
                    title: "Универсальный Конвертер Валют",
                    amountPlaceholder: "Введите сумму",
                    commissionPlaceholder: "Процент комиссии",
                    convertButton: "Рассчитать",
                    resultText: "Изначальная сумма"
                },
                en: {
                    title: "Universal Currency Converter",
                    amountPlaceholder: "Enter amount",
                    commissionPlaceholder: "Commission percentage",
                    convertButton: "Convert",
                    resultText: "Initial Amount"
                },
                uk: {
                    title: "Універсальний Конвертер Валют",
                    amountPlaceholder: "Введіть суму",
                    commissionPlaceholder: "Відсоток комісії",
                    convertButton: "Розрахувати",
                    resultText: "Початкова сума"
                },
                ar: {
                    title: "محول العملات العالمي",
                    amountPlaceholder: "أدخل المبلغ",
                    commissionPlaceholder: "نسبة العمولة",
                    convertButton: "تحويل",
                    resultText: "المبلغ الأولي"
                }
            };

            const translation = translations[selectedLanguage];
            if (translation) {
                document.querySelector("h1").textContent = translation.title;
                document.getElementById("amount").placeholder = translation.amountPlaceholder;
                document.getElementById("commission").placeholder = translation.commissionPlaceholder;
                document.getElementById("convertButton").textContent = translation.convertButton;

                // Обновление текста результатов, если уже есть
                const resultDiv = document.getElementById("result");
                if (resultDiv.textContent) {
                    resultDiv.innerHTML = resultDiv.innerHTML.replace(/Изначальная сумма|Initial Amount|Початкова сума|المبلغ الأولي/, translation.resultText);
                }
            }
        });

        document.getElementById("convertButton").addEventListener("click", convertCurrency);
        document.getElementById("amount").addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                convertCurrency();
            }
        });
    </script>
</body>
